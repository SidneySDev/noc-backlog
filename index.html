<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backlog Management Pro | Sistema de Gest√£o</title>
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.5.2/css/all.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #080818, #000);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', Courier, monospace;
            color: #00ffff;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        /* Login Screen Styles */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .login-container {
            background: rgba(26, 32, 44, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .login-logo i {
            font-size: 2rem;
            color: var(--accent);
        }

        .login-logo span {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--light);
        }

        .login-title {
            font-size: 1.25rem;
            color: var(--light);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--light);
        }

        .form-control {
            padding: 0.75rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            transition: var(--transition);
            background-color: rgba(26, 32, 44, 0.7);
            color: var(--light);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.15);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23a0aec0' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        .login-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .login-btn:hover {
            background-color: var(--primary);
            transform: translateY(-1px);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: rgba(234, 67, 53, 0.1);
            border: 1px solid rgba(234, 67, 53, 0.3);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .login-error.show {
            display: flex;
        }

        .validation-error {
            background: rgba(234, 67, 53, 0.1);
            border: 1px solid rgba(234, 67, 53, 0.3);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .validation-error.show {
            display: flex;
        }

        .fc-event.has-tooltip {
            position: relative;
        }

        .fc-event .tooltip {
            visibility: hidden;
            width: 120px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--light);
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
        }

        .fc-event .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--glass) transparent transparent transparent;
        }

        .fc-event:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .loader-container {
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-center {
            width: 145px;
            height: 145px;
            background: rgba(255, 255, 255, 0.95) !important;
            border-radius: 70%;
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.8), 0 0 60px rgba(30, 64, 175, 1);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: floatRotatePulse 4s ease-in-out infinite;
            z-index: 2;
            border: 2px solid #38bdf8;
            backdrop-filter: blur(10px);
        }

        .icon-center img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: 15px;
        }

        .orbital-ring {
            position: absolute;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border-top: 3px solid #38bdf8;
            border-left: 3px solid transparent;
            border-bottom: 3px solid transparent;
            border-right: 3px solid transparent;
            animation: spin 1.2s linear infinite;
        }

        .orbital-ring::after {
            content: "";
            position: absolute;
            width: 14px;
            height: 14px;
            background: #38bdf8;
            border-radius: 50%;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 14px #38bdf8;
        }

        @keyframes floatRotatePulse {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-8px) rotate(4deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(-8px) rotate(-4deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 30px;
            font-size: 1.2rem;
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            border-right: 3px solid #00ffff;
            width: 0;
            animation: typing 1.5s steps(12) forwards, blinkCaret 0.5s step-end infinite;
            letter-spacing: 2px;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 15ch; }
        }

        @keyframes blinkCaret {
            0%, 100% { border-color: transparent; }
            50% { border-color: #00ffff; }
        }

        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --secondary: #0d47a1;
            --accent: #4285f4;
            --light: #e2e8f0;
            --dark: #1a202c;
            --gray: #a0aec0;
            --light-gray: #4a5568;
            --success: #34a853;
            --warning: #fbbc05;
            --danger: #ea4335;
            --white: rgba(26, 32, 44, 0.8);
            --sidebar-width: 280px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --glass: rgba(26, 32, 44, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --navbar-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 100;
            border-right: 1px solid var(--glass-border);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            transform: translateX(-100%);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            height: var(--navbar-height);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--light);
        }

        .logo-icon {
            color: var(--accent);
            font-size: 1.5rem;
        }

        .nav-menu {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--gray);
            font-weight: 600;
        }

        .nav-item {
            margin: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            transition: var(--transition);
        }

        .nav-item:hover {
            background-color: rgba(66, 133, 244, 0.1);
        }

        .nav-item.active {
            background-color: rgba(66, 133, 244, 0.2);
        }

        .nav-item.active .nav-link {
            color: var(--accent);
        }

        .nav-item.active .nav-icon {
            color: var(--accent);
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--light);
            font-weight: 500;
            font-size: 0.9375rem;
        }

        .nav-icon {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            color: var(--gray);
            width: 24px;
            display: flex;
            justify-content: center;
        }

        .user-panel {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--light);
        }

        .user-role {
            font-size: 0.8125rem;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: var(--transition);
            margin-left: 0.5rem;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 90;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.25rem;
            cursor: pointer;
            margin-right: 1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background-color: rgba(66, 133, 244, 0.1);
            color: var(--accent);
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--light);
            margin-right: auto;
        }

        .navbar-tools {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 40px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            margin-top: var(--navbar-height);
            padding: 1.5rem;
            width: 100%;
            transition: var(--transition);
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border);
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            border-color: rgba(66, 133, 244, 0.3);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--light);
        }

        .card-tools {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .form-group {
            flex: 1;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--light);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            transition: var(--transition);
            background-color: rgba(26, 32, 44, 0.5);
            color: var(--light);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.15);
            background-color: rgba(26, 32, 44, 0.7);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23a0aec0' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        .editor-container {
            border: 1px solid var(--light-gray);
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: rgba(26, 32, 44, 0.7);
            width: 100%;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            padding: 0.5rem;
            background-color: rgba(26, 32, 44, 0.9);
            border-bottom: 1px solid var(--light-gray);
        }

        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding-right: 0.5rem;
            border-right: 1px solid var(--light-gray);
            margin-right: 0.5rem;
        }

        .toolbar-group:last-child {
            border-right: none;
            margin-right: 0;
        }

        .toolbar-btn {
            background: none;
            border: none;
            color: var(--gray);
            width: 32px;
            height: 32px;
            border-radius: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .toolbar-btn:hover {
            background-color: rgba(66, 133, 244, 0.2);
            color: var(--accent);
        }

        .toolbar-btn.active {
            background-color: rgba(66, 133, 244, 0.3);
            color: var(--accent);
        }

        .color-picker {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            cursor: pointer;
            background: none;
        }

        .editor-content {
            min-height: 300px;
            max-height: 600px;
            padding: 1rem;
            outline: none;
            overflow-y: auto;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary);
            transform: translateY(-1px);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--light-gray);
            color: var(--light);
        }

        .btn-outline:hover {
            background-color: rgba(66, 133, 244, 0.1);
            border-color: var(--accent);
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .fc {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            color: var(--light);
        }

        .fc-header-toolbar {
            padding: 1.5rem;
            margin-bottom: 0 !important;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .fc-toolbar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--light);
        }

        .fc-button {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid var(--glass-border) !important;
            color: var(--light) !important;
            font-weight: 500 !important;
            transition: var(--transition) !important;
            border-radius: 0.75rem !important;
            padding: 0.5rem 1rem !important;
            backdrop-filter: blur(5px);
        }

        .fc-button:hover {
            background-color: rgba(66, 133, 244, 0.2) !important;
        }

        .fc-button-primary:not(:disabled).fc-button-active {
            background-color: var(--accent) !important;
            border-color: var(--accent) !important;
            color: white !important;
        }

        .fc-daygrid-day {
            border: 1px solid var(--glass-border) !important;
            background: rgba(255, 255, 255, 0.03);
            transition: all 0.3s ease;
        }

        .fc-daygrid-day:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .fc-daygrid-day-number {
            color: var(--light);
            font-weight: 500;
            padding: 0.5rem;
        }

        .fc-daygrid-day.fc-day-today {
            background-color: rgba(66, 133, 244, 0.15) !important;
        }

        .fc-daygrid-day.fc-day-today .fc-daygrid-day-number {
            color: var(--accent);
            font-weight: 600;
        }

        .fc-daygrid-event {
            border-radius: 0.75rem !important;
            padding: 0.5rem !important;
            font-size: 0.85rem !important;
            background: rgba(66, 133, 244, 0.25) !important;
            border: none !important;
            color: var(--light) !important;
            margin: 0.25rem 0.5rem !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            transition: all 0.3s ease;
        }

        .fc-daygrid-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: rgba(66, 133, 244, 0.35) !important;
        }

        .fc-event-main {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem;
        }

        .fc-event-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .fc-event-dot {
            display: none !important;
        }

        .fc-col-header-cell {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border) !important;
            padding: 0.75rem 0;
        }

        .fc-col-header-cell-cushion {
            color: var(--light);
            font-weight: 500;
        }

        .event-delano {
            background: rgba(101, 163, 13, 0.25) !important;
            border-color: rgba(101, 163, 13, 0.3) !important;
        }

        .event-herbeth {
            background: rgba(220, 38, 38, 0.25) !important;
            border-color: rgba(220, 38, 38, 0.3) !important;
        }

        .event-welligton {
            background: rgba(234, 88, 12, 0.25) !important;
            border-color: rgba(234, 88, 12, 0.3) !important;
        }

        .event-edmundo {
            background: rgba(139, 92, 246, 0.25) !important;
            border-color: rgba(139, 92, 246, 0.3) !important;
        }

        .event-sidney {
            background: rgba(20, 184, 166, 0.25) !important;
            border-color: rgba(20, 184, 166, 0.3) !important;
        }

        .event-marcio {
            background: rgba(236, 72, 153, 0.25) !important;
            border-color: rgba(236, 72, 153, 0.3) !important;
        }

        .event-helielton {
            background: rgba(59, 130, 246, 0.25) !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
        }

        .event-robson {
            background: rgba(245, 158, 11, 0.25) !important;
            border-color: rgba(245, 158, 11, 0.3) !important;
        }

        .event-wyllame {
            background: rgba(5, 150, 105, 0.25) !important;
            border-color: rgba(5, 150, 105, 0.3) !important;
        }

        .event-darlyson {
            background: rgba(217, 70, 239, 0.25) !important;
            border-color: rgba(217, 70, 239, 0.3) !important;
        }

        .event-murilo {
            background: rgba(6, 182, 212, 0.25) !important;
            border-color: rgba(6, 182, 212, 0.3) !important;
        }

        .event-onofre {
            background: rgba(249, 115, 22, 0.25) !important;
            border-color: rgba(249, 115, 22, 0.3) !important;
        }

        .event-lynna {
            background: rgba(190, 24, 93, 0.25) !important;
            border-color: rgba(190, 24, 93, 0.3) !important;
        }

        .fc-event-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .fc-event-modal-content {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            color: var(--light);
        }

        .fc-event-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .fc-event-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--light);
            margin: 0;
        }

        .fc-event-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--light);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .fc-event-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .fc-event-analyst-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--glass-border);
            transition: var(--transition);
        }

        .fc-event-analyst-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .fc-event-analyst-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fc-event-analyst-content {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--gray);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border);
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--light);
            margin-bottom: 0.25rem;
        }

        .stat-change {
            font-size: 0.8125rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        .analyst-stats-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .analyst-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .analyst-stat-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border);
        }

        .analyst-stat-card.wide {
            grid-column: span 2;
        }

        .analyst-ranking {
            margin-top: 1rem;
        }

        .analyst-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .analyst-item:last-child {
            border-bottom: none;
        }

        .analyst-name {
            font-weight: 500;
            color: var(--light);
        }

        .analyst-count {
            font-weight: 600;
            color: var(--accent);
        }

        .analyst-details {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .analyst-detail-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .analyst-detail-item:last-child {
            border-bottom: none;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 1.5rem;
        }

        .medal {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
        }

        .silver {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: #000;
        }

        .bronze {
            background: linear-gradient(135deg, #CD7F32, #A05A2C);
            color: #fff;
        }

        .month-filter {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .month-filter label {
            font-weight: 500;
            color: var(--light);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 80;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .mural-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .mural-info {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            border: 1px solid var(--glass-border);
            font-size: 0.9rem;
            color: var(--gray);
        }

        .mural-warning {
            background: rgba(251, 188, 5, 0.1);
            border-color: rgba(251, 188, 5, 0.3);
            color: var(--warning);
        }

        /* ===== NOVO ESTILO DO MURAL CYAN/TEAL ===== */
        :root {
            --bg: #061018;
            --panel: #081b24;
            --panel2: #0b2230;
            --stroke: rgba(255,255,255,.10);
            --stroke2: rgba(255,255,255,.16);
            --text: #e8fbff;
            --muted: rgba(232,251,255,.62);
            --muted2: rgba(232,251,255,.42);
            --accent-cyan: #06b6d4;
            --accent2-cyan: #0891b2;
            --accentGlow: rgba(6,182,212,.20);
            --success: #22c55e;
            --danger: #ef4444;
            --warn: #f59e0b;
            --radius: 16px;
            --shadow: 0 16px 40px rgba(0,0,0,.35);
            --maxw: 1100px;
        }

        .mural-cyan {
            background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .chat-messages {
            height: min(70vh, 680px);
            overflow-y: auto;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--panel);
        }

        .chat-messages::-webkit-scrollbar { width: 10px; }
        .chat-messages::-webkit-scrollbar-track { background: rgba(255,255,255,.03); }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(232,251,255,.18);
            border-radius: 999px;
            border: 2px solid rgba(0,0,0,0);
            background-clip: padding-box;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: rgba(232,251,255,.28); }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
        }
        .message-wrapper.own { align-items: flex-end; }
        .message-wrapper.system .message-bubble {
            opacity: .92;
            font-style: italic;
            background: rgba(255,255,255,.03);
        }

        .message-bubble {
            width: min(820px, 94%);
            border-radius: 16px;
            padding: 10px 12px;
            background: rgba(255,255,255,.03);
            border: 1px solid var(--stroke);
        }
        .message-wrapper.own .message-bubble {
            background: color-mix(in srgb, var(--accent-cyan) 12%, transparent);
            border-color: color-mix(in srgb, var(--accent-cyan) 26%, transparent);
        }

        .message-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 6px;
        }

        .message-author {
            display: flex;
            gap: 8px;
            align-items: center;
            font-weight: 750;
            font-size: .86rem;
            color: color-mix(in srgb, var(--accent-cyan) 92%, white 8%);
        }
        .message-wrapper.own .message-author { color: rgba(232,251,255,.95); }
        .message-wrapper.system .message-author { color: rgba(232,251,255,.70); }

        .message-time {
            font-size: .74rem;
            color: var(--muted2);
            white-space: nowrap;
        }
        .edited-badge {
            font-size: .70rem;
            opacity: .85;
            margin-left: 6px;
            font-style: italic;
        }

        .message-content {
            white-space: pre-wrap;
            line-height: 1.45;
            color: rgba(232,251,255,.92);
            word-break: break-word;
        }

        .message-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
            opacity: .92;
        }
        .message-footer button {
            border: 1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.04);
            color: rgba(232,251,255,.80);
            border-radius: 999px;
            padding: 6px 10px;
            cursor: pointer;
            transition: .14s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: .80rem;
        }
        .message-footer button:hover {
            transform: translateY(-1px);
            background: rgba(255,255,255,.08);
            color: rgba(232,251,255,.95);
            border-color: rgba(255,255,255,.16);
        }
        .message-footer .danger {
            border-color: rgba(239,68,68,.35);
            background: rgba(239,68,68,.12);
            color: rgba(255,225,225,.95);
        }
        .message-footer .danger:hover {
            background: rgba(239,68,68,.18);
            border-color: rgba(239,68,68,.55);
            color: rgba(255,235,235,.98);
        }

        .inc-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            border: 1px solid color-mix(in srgb, var(--accent-cyan) 50%, transparent);
            background: color-mix(in srgb, var(--accent-cyan) 16%, transparent);
            color: rgba(232,251,255,.98);
            font-weight: 800;
            font-size: .86rem;
            cursor: pointer;
            user-select: none;
            transition: .12s ease;
            white-space: nowrap;
        }
        .inc-pill:hover {
            background: color-mix(in srgb, var(--accent-cyan) 22%, transparent);
            transform: translateY(-1px);
        }

        .edit-mode {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .edit-mode textarea {
            width: 100%;
            min-height: 110px;
            max-height: 240px;
            resize: vertical;
            outline: none;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: color-mix(in srgb, var(--bg) 72%, transparent);
            color: rgba(232,251,255,.95);
            padding: 12px;
            font-size: .95rem;
            line-height: 1.45;
            transition: .12s ease;
            font-family: inherit;
        }
        .edit-mode textarea:focus {
            border-color: color-mix(in srgb, var(--accent-cyan) 45%, transparent);
            box-shadow: 0 0 0 6px var(--accentGlow);
        }
        .edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }
        .edit-actions button {
            border-radius: 999px;
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.05);
            color: rgba(232,251,255,.9);
            cursor: pointer;
            transition: .14s ease;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .edit-actions button:hover { transform: translateY(-1px); background: rgba(255,255,255,.08); }
        .edit-actions .cancel {
            color: rgba(255,225,225,.98);
            border-color: rgba(239,68,68,.35);
            background: rgba(239,68,68,.12);
        }

        .chat-input-area {
            border-top: 1px solid rgba(255,255,255,.10);
            background: var(--panel2);
            padding: 10px 12px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.04);
            padding: 10px 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            transition: .12s ease;
        }
        .input-wrapper:focus-within {
            border-color: color-mix(in srgb, var(--accent-cyan) 45%, transparent);
            box-shadow: 0 0 0 6px var(--accentGlow);
            background: rgba(255,255,255,.05);
        }
        .input-icon {
            color: color-mix(in srgb, var(--accent-cyan) 92%, white 8%);
            margin-top: 4px;
            flex: 0 0 auto;
        }
        .chat-input-area textarea {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: rgba(232,251,255,.95);
            font-size: .98rem;
            line-height: 1.35;
            resize: none;
            height: 24px;
            max-height: 140px;
            overflow-y: auto;
            padding: 0;
            font-family: inherit;
        }
        .chat-input-area textarea::placeholder { color: rgba(232,251,255,.45); }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            border: 1px solid color-mix(in srgb, var(--accent-cyan) 38%, transparent);
            background: linear-gradient(135deg,
                color-mix(in srgb, var(--accent-cyan) 92%, white 8%),
                color-mix(in srgb, var(--accent2-cyan) 92%, white 8%)
            );
            color: rgba(232,251,255,.98);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: .14s ease;
        }
        .send-btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
        .send-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

        .flash {
            animation: flash .35s ease;
        }
        @keyframes flash {
            0% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
            50% { box-shadow: 0 0 0 7px var(--accentGlow); }
            100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
        }

        .deleting {
            animation: vanish .22s ease forwards;
        }
        @keyframes vanish {
            to { opacity: 0; transform: translateY(-6px); filter: blur(1px); }
        }

        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 20;
            background: color-mix(in srgb, var(--panel2) 86%, transparent);
            border: 1px solid rgba(255,255,255,.12);
            color: rgba(232,251,255,.95);
            padding: 10px 12px;
            border-radius: 14px;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(10px);
            transition: .16s ease;
            max-width: 360px;
            pointer-events: none;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            line-height: 1.35;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-icon {
            width: 28px; height: 28px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.10);
            flex: 0 0 auto;
            margin-top: 1px;
        }
        .toast.success .toast-icon { border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
        .toast.error .toast-icon { border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); }
        .toast.info .toast-icon { border-color: rgba(6,182,212,.28); background: rgba(6,182,212,.12); }

        @media (max-width: 992px) {
            .analyst-stat-card.wide {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 1rem;
            }
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            .analyst-stats-grid {
                grid-template-columns: 1fr;
            }
            .editor-content {
                min-height: 250px;
            }
            .mural-status {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
            .message-bubble { width: 96%; }
        }

        @media (min-width: 992px) {
            .sidebar {
                transform: translateX(0);
            }
            .main-content {
                margin-left: var(--sidebar-width);
            }
            .menu-toggle {
                display: none;
            }
        }

        .text-bold { font-weight: bold; }
        .text-italic { font-style: italic; }
        .text-underline { text-decoration: underline; }
        .text-highlight { background-color: yellow; color: black; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--light-gray); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gray); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out; }

        .jsonbin-tag {
            display: inline-block;
            background-color: #f59e0b;
            color: #000;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .inc-link {
            color: var(--light) !important;
            font-weight: bold;
            text-decoration: none !important;
            padding: 2px 8px !important;
            border-radius: 4px !important;
            background-color: rgba(34, 112, 238, 0.2) !important;
            border: 1.5px solid var(--accent) !important;
            transition: var(--transition) !important;
            display: inline-block;
            position: relative;
        }

        .inc-link:hover {
            background-color: rgba(66, 133, 244, 0.3) !important;
            transform: translateY(-1px);
        }

        .inc-link::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 1px;
            background-color: #ff6b6b;
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }

        .inc-link:hover::after {
            transform: scaleX(1);
        }

        #notes-section .card-body { min-height: 500px; }
        #backlog-text { min-height: 800px; }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="loader-container">
            <div class="icon-center">
                <img src="./logobacklog.png" />
            </div>
            <div class="orbital-ring"></div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-tasks logo-icon"></i>
                    <span>Backlog NOC</span>
                </div>
                <h2 class="login-title">Acesso ao Sistema</h2>
                <p class="login-subtitle">Fa√ßa login para acessar o sistema</p>
            </div>

            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label class="form-label">Analista</label>
                    <select class="form-control form-select" id="login-analista" required>
                        <option value="">Selecione o analista</option>
                        <option value="DELANO">DELANO</option>
                        <option value="HERBETH">HERBETH</option>
                        <option value="WELLIGTON">WELLIGTON</option>
                        <option value="EDMUNDO">EDMUNDO</option>
                        <option value="SIDNEY">SIDNEY</option>
                        <option value="MARCIO">MARCIO</option>
                        <option value="HELIELTON">HELIELTON</option>
                        <option value="ROBSON">ROBSON</option>
                        <option value="WYLLAME">WYLLAME</option>
                        <option value="DARLYSON">DARLYSON</option>
                        <option value="MURILO">MURILO</option>
                        <option value="ONOFRE">ONOFRE</option>
                        <option value="LYNNA">LYNNA</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Digite a senha" required />
                </div>

                <div class="login-error" id="login-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="error-message">Credenciais inv√°lidas</span>
                </div>

                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- App -->
    <div id="app-container" class="app-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-tasks logo-icon"></i>
                    <span>Backlog NOC</span>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-title">Menu Principal</div>

                <div class="nav-item active" data-section="notes">
                    <a href="#" class="nav-link">
                        <i class="fas fa-edit nav-icon"></i>
                        <span>Anota√ß√µes</span>
                    </a>
                </div>

                <div class="nav-item" data-section="dashboard">
                    <a href="#" class="nav-link">
                        <i class="fas fa-calendar-alt nav-icon"></i>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="nav-item" data-section="mural">
                    <a href="#" class="nav-link">
                        <i class="fas fa-users nav-icon"></i>
                        <span>Mural</span>
                    </a>
                </div>
            </div>

            <div class="user-panel">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-info">
                    <div class="user-name" id="user-name">Usu√°rio</div>
                    <div class="user-role">Analista NOC</div>
                </div>
                <button class="logout-btn" id="logout-btn" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Navbar -->
        <nav class="navbar">
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="page-title">Anota√ß√µes</h1>
            <div class="navbar-tools">
                <button class="btn btn-outline btn-icon" id="fullscreen-toggle">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </nav>

        <!-- Main content -->
        <div class="main-content" id="main-content">
            <div class="content-body">
                <!-- Notes -->
                <div class="section-content" id="notes-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Registro de Backlog Di√°rio</h3>
                            <div class="card-tools">
                                <button class="btn btn-outline">
                                    <i class="fas fa-history"></i> Hist√≥rico
                                </button>
                            </div>
                        </div>

                        <div class="card-body">
                            <form id="backlog-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Analista</label>
                                        <input type="text" class="form-control" id="analista-display" readonly />
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Data</label>
                                        <input type="date" class="form-control" id="data-backlog" required />
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Backlog Validado</label>
                                    <div class="editor-container">
                                        <div class="toolbar">
                                            <div class="toolbar-group">
                                                <button type="button" class="toolbar-btn" data-command="bold" title="Negrito (Ctrl+B)">
                                                    <i class="fas fa-bold"></i>
                                                </button>
                                                <button type="button" class="toolbar-btn" data-command="italic" title="It√°lico (Ctrl+I)">
                                                    <i class="fas fa-italic"></i>
                                                </button>
                                                <button type="button" class="toolbar-btn" data-command="underline" title="Sublinhado (Ctrl+U)">
                                                    <i class="fas fa-underline"></i>
                                                </button>
                                            </div>

                                            <div class="toolbar-group">
                                                <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Lista n√£o ordenada">
                                                    <i class="fas fa-list-ul"></i>
                                                </button>
                                                <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Lista ordenada">
                                                    <i class="fas fa-list-ol"></i>
                                                </button>
                                            </div>

                                            <div class="toolbar-group">
                                                <button type="button" class="toolbar-btn" data-command="hiliteColor" data-value="yellow" title="Marcador de texto">
                                                    <i class="fas fa-highlighter"></i>
                                                </button>
                                                <input type="color" class="color-picker" id="text-color" value="#e2e8f0" title="Cor do texto" />
                                                <input type="color" class="color-picker" id="bg-color" value="#1a202c" title="Cor de fundo" />
                                            </div>

                                            <div class="toolbar-group">
                                                <button type="button" class="toolbar-btn" data-command="undo" title="Desfazer (Ctrl+Z)">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                                <button type="button" class="toolbar-btn" data-command="redo" title="Refazer (Ctrl+Y)">
                                                    <i class="fas fa-redo"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="editor-content" id="backlog-text" contenteditable="true" placeholder="Descreva detalhadamente o backlog validado..."></div>
                                    </div>
                                </div>

                                <div class="action-buttons">
                                    <button type="button" class="btn btn-outline" id="clear-form">
                                        <i class="fas fa-trash-alt"></i> Limpar
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="save-backlog">
                                        <i class="fas fa-save"></i> Salvar Backlog
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Dashboard -->
                <div class="section-content" id="dashboard-section" style="display: none;">
                    <div class="analyst-stats-container">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Calend√°rio de Valida√ß√µes</h3>
                            </div>
                            <div class="card-body">
                                <div id="calendar"></div>
                            </div>
                        </div>

                        <div class="month-filter">
                            <label for="month-select">Filtrar por m√™s:</label>
                            <select id="month-select" class="form-control form-select">
                                <option value="">Todos os meses</option>
                            </select>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-title">Valida√ß√µes Hoje</div>
                                <div class="stat-value" id="validations-today">0</div>
                                <div class="stat-change" id="today-change">
                                    <i class="fas fa-caret-up"></i> 0% em rela√ß√£o a ontem
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-title">Valida√ß√µes no M√™s</div>
                                <div class="stat-value" id="validations-month">0</div>
                                <div class="stat-change" id="month-change">
                                    <i class="fas fa-caret-up"></i> 0% em rela√ß√£o ao m√™s passado
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-title">Analista Mais Ativo</div>
                                <div class="stat-value" id="top-analyst">N/A</div>
                                <div class="stat-value" id="top-analyst-count">0 valida√ß√µes</div>
                            </div>
                        </div>

                        <div class="analyst-stats-grid">
                            <div class="analyst-stat-card">
                                <h3 class="card-title">Top Analistas</h3>
                                <div class="analyst-ranking" id="top-analysts"></div>
                            </div>

                            <div class="analyst-stat-card">
                                <h3 class="card-title">Analistas com Menos Registros</h3>
                                <div class="analyst-ranking" id="bottom-analysts"></div>
                            </div>

                            <div class="analyst-stat-card wide">
                                <h3 class="card-title">Relat√≥rios por Analista</h3>
                                <div class="chart-container">
                                    <canvas id="analystChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mural - NOVO ESTILO CYAN/TEAL -->
                <div class="section-content" id="mural-section" style="display: none;">
                    <div class="mural-container">
                        <div class="mural-info mural-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Aten√ß√£o:</strong> O mural √© como um chat em grupo. Voc√™ pode copiar qualquer mensagem, editar e excluir apenas as suas. INCxxxxx vira bot√£o clic√°vel (duplo clique abre ServiceNow).
                        </div>

                        <div class="mural-cyan">
                            <div class="chat-messages" id="chat-messages"></div>

                            <div class="chat-input-area">
                                <div class="input-wrapper">
                                    <i class="fa-solid fa-pen-to-square input-icon"></i>
                                    <textarea id="chat-input" placeholder="Digite sua mensagem... (Enter envia / Shift+Enter quebra linha)" rows="1"></textarea>
                                </div>
                                <button class="send-btn" id="chat-send" title="Enviar"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Toast -->
                <div class="toast" id="toast">
                    <div class="toast-icon" id="toast-icon"><i class="fa-solid fa-circle-info"></i></div>
                    <div id="toast-message">OK</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js"></script>
    <script>
        // Usu√°rios
        const USERS = {
            'DELANO': 'noc@2025',
            'HERBETH': 'noc@2025',
            'WELLIGTON': 'noc@2025',
            'EDMUNDO': 'noc@2025',
            'SIDNEY': 'noc@2025adm',
            'MARCIO': 'noc@2025',
            'HELIELTON': 'noc@2025',
            'ROBSON': 'noc@2025',
            'WYLLAME': 'noc@2025',
            'DARLYSON': 'noc@2025',
            'MURILO': 'noc@2025',
            'ONOFRE': 'noc@2025',
            'LYNNA': 'noc@2025'
        };

        // Splash
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';

                setTimeout(function () {
                    splash.style.display = 'none';
                    checkAuthentication();
                }, 200);
            }, 3000);
        });

        // Verifica login
        function checkAuthentication() {
            let currentUser = sessionStorage.getItem('currentUser');

            if (!currentUser) {
                currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    sessionStorage.setItem('currentUser', currentUser);
                }
            }

            if (currentUser) {
                document.getElementById('login-screen').style.display = 'none';
                initApplication(currentUser);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const analista = document.getElementById('login-analista').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');

            if (USERS[analista] && password === USERS[analista]) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';

                setTimeout(function () {
                    sessionStorage.setItem('currentUser', analista);
                    localStorage.setItem('currentUser', analista);

                    document.getElementById('login-screen').style.display = 'none';
                    initApplication(analista);
                }, 1000);
            } else {
                loginError.classList.add('show');
                document.getElementById('error-message').textContent = 'Analista ou senha incorretos';

                setTimeout(function () {
                    loginError.classList.remove('show');
                }, 3000);
            }
        });

        function setupLogout() {
            document.getElementById('logout-btn').addEventListener('click', function () {
                if (confirm('Tem certeza que deseja sair do sistema?')) {
                    sessionStorage.removeItem('currentUser');
                    localStorage.removeItem('currentUser');
                    location.reload();
                }
            });
        }

        function initApplication(currentUser) {
            // Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBWBGcnOlv2Gu_0hN17qIGW6RKL3uITbzY",
                authDomain: "bancodedados-snzb.firebaseapp.com",
                projectId: "bancodedados-snzb",
                storageBucket: "bancodedados-snzb.appspot.com",
                messagingSenderId: "573270416863",
                appId: "1:573270416863:web:81455e206b4d252d29b86a"
            };

            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // JSONBin (leitura)
            const BIN_ID = '685632118960c979a5ae30ac';
            const MASTER_KEY = '$2a$10$YMdKhRE5rs2j/addb0u2beEv8Buf0LgOpYvT5YQhwzDZqIfxBOsWK';
            const ACCESS_KEY = '$2a$10$SpeE5.rHPveOV83qARbVqOkmjogz4ZOF6pahjv8ju7cEPDnPdt4rq';
            const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

            // Regras de edi√ß√£o
            const BACKLOG_EDIT_WINDOW_MS = 60 * 60 * 1000; // 1 hora
            const MAX_BACKLOG_SAVES = 5; // 1 cria√ß√£o + 4 sobrescritas

            // Elementos
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuToggle = document.getElementById('menu-toggle');
            const navItems = document.querySelectorAll('.nav-item');
            const sectionContents = document.querySelectorAll('.section-content');
            const dataBacklog = document.getElementById('data-backlog');
            const analistaDisplay = document.getElementById('analista-display');
            const backlogText = document.getElementById('backlog-text');
            const backlogForm = document.getElementById('backlog-form');
            const clearFormBtn = document.getElementById('clear-form');
            const saveButton = document.getElementById('save-backlog');
            const toast = document.getElementById('toast');
            const fullscreenToggle = document.getElementById('fullscreen-toggle');
            const pageTitle = document.querySelector('.page-title');
            const monthSelect = document.getElementById('month-select');

            // Dashboard
            const validationsTodayEl = document.getElementById('validations-today');
            const todayChangeEl = document.getElementById('today-change');
            const validationsMonthEl = document.getElementById('validations-month');
            const monthChangeEl = document.getElementById('month-change');
            const topAnalystEl = document.getElementById('top-analyst');
            const topAnalystCountEl = document.getElementById('top-analyst-count');
            const topAnalystsEl = document.getElementById('top-analysts');
            const bottomAnalystsEl = document.getElementById('bottom-analysts');
            const analystChartEl = document.getElementById('analystChart');

            // Mural - NOVOS ELEMENTOS
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');

            // Refer√™ncias Firestore para o mural
            const muralMessagesRef = db.collection('mural_messages');
            const muralMetadataRef = db.collection('mural_metadata').doc('daily');

            // Usu√°rio logado
            analistaDisplay.value = currentUser;
            document.getElementById('user-name').textContent = currentUser;
            document.getElementById('user-avatar').textContent = currentUser.charAt(0);

            function getFortalezaDateString() {
                return new Date().toLocaleDateString('pt-BR', {
                    timeZone: 'America/Fortaleza'
                }).split('/').reverse().join('-');
            }

            function getFortalezaTimestamp() {
                const now = new Date();
                const timeString = now.toLocaleString('pt-BR', {
                    timeZone: 'America/Fortaleza',
                    hour12: false
                });
                const [datePart, timePart] = timeString.split(', ');
                const [day, month, year] = datePart.split('/');
                const [hours, minutes, seconds] = timePart.split(':');
                const ms = now.getMilliseconds().toString().padStart(3, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}.${ms}-03:00`;
            }

            // Fun√ß√£o para ID do documento por m√™s
            function getBacklogDocId(data) {
                const [ano, mes] = data.split('-');
                const meses = {
                    '01': 'janeiro', '02': 'fevereiro', '03': 'mar√ßo', '04': 'abril',
                    '05': 'maio', '06': 'junho', '07': 'julho', '08': 'agosto',
                    '09': 'setembro', '10': 'outubro', '11': 'novembro', '12': 'dezembro'
                };
                const nomeMes = meses[mes];
                const anoCurto = ano.slice(2);
                return `${nomeMes}${anoCurto}`;
            }

            dataBacklog.value = getFortalezaDateString();

            const validationError = document.createElement('div');
            validationError.className = 'validation-error';
            validationError.innerHTML = '<i class="fas fa-exclamation-circle"></i><span id="validation-message"></span>';
            backlogForm.insertBefore(validationError, backlogForm.querySelector('.action-buttons'));

            let backlogData = {
                meta: {
                    sistema: "Backlog do NOC",
                    versao: "1.0",
                    ultima_atualizacao: null,
                    criado_em: new Date().toISOString()
                },
                registros: []
            };
            let firebaseRecords = [];
            let analystChart = null;
            let muralUnsubscribe = null;

            setupLogout();
            document.getElementById('app-container').style.display = 'flex';

            function showValidationError(message) {
                validationError.classList.add('show');
                document.getElementById('validation-message').textContent = message;
                setTimeout(() => {
                    validationError.classList.remove('show');
                }, 5000);
            }

            function cleanBacklogText(text) {
                if (!text) return '';
                return text
                    .replace(/<br\s*\/?>/gi, '\n')
                    .replace(/<div>/gi, '')
                    .replace(/<\/div>/gi, '\n')
                    .replace(/<[^>]*>/g, '')
                    .replace(/&nbsp;/g, ' ')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/\*\*/g, '')
                    .replace(/\*{2,}/g, '')
                    .replace(/^\*|\*$/gm, '')
                    .replace(/\n\s*\n/g, '\n\n')
                    .replace(/^\s+|\s+$/g, '')
                    .trim();
            }

            function formatIncLinks(text) {
                const incRegex = /(^|\s)(INC\d{5,})(?=\s|$)/gi;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;

                const walker = document.createTreeWalker(
                    tempDiv,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: function (node) {
                            if (node.parentNode.classList && node.parentNode.classList.contains('inc-link')) {
                                return NodeFilter.FILTER_REJECT;
                            }
                            return NodeFilter.FILTER_ACCEPT;
                        }
                    }
                );

                const textNodes = [];
                let currentNode;
                while (currentNode = walker.nextNode()) {
                    textNodes.push(currentNode);
                }

                textNodes.forEach(node => {
                    const parent = node.parentNode;
                    const originalText = node.nodeValue;
                    const fragment = document.createDocumentFragment();
                    let lastIndex = 0;
                    let match;

                    while ((match = incRegex.exec(originalText)) !== null) {
                        if (match.index > lastIndex) {
                            fragment.appendChild(document.createTextNode(originalText.substring(lastIndex, match.index)));
                        }

                        const numeroINC = match[2];
                        const serviceNowUrl = `https://equatorialenergia.service-now.com/incident.do?sysparm_query=number=${numeroINC}`;

                        const incLink = document.createElement('span');
                        incLink.className = 'inc-link';
                        incLink.setAttribute('data-url', serviceNowUrl);
                        incLink.textContent = numeroINC;

                        fragment.appendChild(incLink);
                        lastIndex = match.index + match[0].length;
                    }

                    if (lastIndex < originalText.length) {
                        fragment.appendChild(document.createTextNode(originalText.substring(lastIndex)));
                    }

                    if (fragment.childNodes.length > 0) {
                        parent.replaceChild(fragment, node);
                    }
                });

                return tempDiv.innerHTML;
            }

            function showToast(message, type = 'success', duration = 3000) {
                const toastEl = document.getElementById('toast');
                const toastMsg = document.getElementById('toast-message');
                const toastIcon = document.getElementById('toast-icon');
                
                toastMsg.textContent = message;
                toastEl.className = `toast ${type}`;
                
                const icon = type === 'success' ? 'fa-circle-check' 
                           : type === 'error' ? 'fa-triangle-exclamation' 
                           : 'fa-circle-info';
                toastIcon.innerHTML = `<i class="fa-solid ${icon}"></i>`;
                
                toastEl.classList.add('show');
                setTimeout(() => {
                    toastEl.classList.remove('show');
                }, duration);
            }

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });

            fullscreenToggle.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        showToast(`Erro ao entrar em tela cheia: ${err.message}`, 'error');
                    });
                    fullscreenToggle.innerHTML = '<i class="fas fa-compress"></i>';
                } else if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenToggle.innerHTML = '<i class="fas fa-expand"></i>';
                }
            });

            function execCommandOnEditor(editorElement, command, value = null) {
                if (!editorElement) return;
                editorElement.focus();
                document.execCommand(command, false, value);
            }

            backlogText.addEventListener('keydown', function (e) {
                if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    execCommandOnEditor(backlogText, 'bold');
                } else if (e.ctrlKey && e.key === 'i') {
                    e.preventDefault();
                    execCommandOnEditor(backlogText, 'italic');
                } else if (e.ctrlKey && e.key === 'u') {
                    e.preventDefault();
                    execCommandOnEditor(backlogText, 'underline');
                } else if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    execCommandOnEditor(backlogText, 'undo');
                } else if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    execCommandOnEditor(backlogText, 'redo');
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('save-backlog').click();
                }
            });

            backlogText.addEventListener('keydown', function (e) {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const range = selection.getRangeAt(0);
                const node = range.startContainer;
                const incLink = node.parentNode.closest('.inc-link');
                if (!incLink) return;

                if (['ArrowRight', 'ArrowLeft', 'ArrowUp', 'ArrowDown', 'End', 'Home', 'Escape'].includes(e.key)) {
                    e.preventDefault();
                    let newRange = document.createRange();
                    let spaceNode;

                    if (e.key === 'ArrowRight' || e.key === 'End') {
                        spaceNode = document.createTextNode('   ');
                        incLink.parentNode.insertBefore(spaceNode, incLink.nextSibling);
                        newRange.setStartAfter(spaceNode);
                    } else if (e.key === 'ArrowLeft' || e.key === 'Home') {
                        newRange.setStartBefore(incLink);
                    } else if (e.key === 'Escape') {
                        spaceNode = document.createTextNode('   ');
                        incLink.parentNode.insertBefore(spaceNode, incLink.nextSibling);
                        newRange.setStartAfter(spaceNode);
                    }

                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            });

            document.querySelectorAll('.toolbar-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const command = this.dataset.command;
                    const value = this.dataset.value;
                    const editorContainer = this.closest('.editor-container');
                    const editorContent = editorContainer
                        ? editorContainer.querySelector('.editor-content')
                        : backlogText;

                    if (command === 'hiliteColor') {
                        execCommandOnEditor(editorContent, 'hiliteColor', value || 'yellow');
                    } else {
                        execCommandOnEditor(editorContent, command);
                    }
                });
            });

            const textColorPicker = document.getElementById('text-color');
            const bgColorPicker = document.getElementById('bg-color');

            textColorPicker.addEventListener('change', function () {
                execCommandOnEditor(backlogText, 'foreColor', this.value);
            });

            bgColorPicker.addEventListener('change', function () {
                execCommandOnEditor(backlogText, 'hiliteColor', this.value);
            });

            backlogText.addEventListener('input', () => {
                setTimeout(() => {
                    const selection = window.getSelection();
                    const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
                    let cursorOffset = 0;

                    if (range) {
                        const preRange = range.cloneRange();
                        preRange.selectNodeContents(backlogText);
                        preRange.setEnd(range.startContainer, range.startOffset);
                        cursorOffset = preRange.toString().length;
                    }

                    const currentHtml = backlogText.innerHTML;
                    const formattedHtml = formatIncLinks(currentHtml);

                    if (formattedHtml !== currentHtml) {
                        backlogText.innerHTML = formattedHtml;

                        if (range) {
                            const newRange = document.createRange();
                            let charCount = 0;
                            let foundNode = null;
                            let foundOffset = 0;

                            const walker = document.createTreeWalker(
                                backlogText,
                                NodeFilter.SHOW_TEXT,
                                null,
                                false
                            );

                            let node;
                            while (node = walker.nextNode()) {
                                const length = node.nodeValue.length;
                                if (charCount + length >= cursorOffset) {
                                    foundNode = node;
                                    foundOffset = cursorOffset - charCount;
                                    break;
                                }
                                charCount += length;
                            }

                            if (foundNode) {
                                newRange.setStart(foundNode, foundOffset);
                                newRange.collapse(true);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            }
                        }
                    }
                }, 0);
            });

            backlogText.addEventListener('dblclick', function (e) {
                const incLink = e.target.closest('.inc-link');
                if (incLink) {
                    e.preventDefault();
                    const url = incLink.getAttribute('data-url');
                    window.open(url, '_blank');
                }
            });

            async function loadJsonBinData() {
                try {
                    showToast('Carregando dados do JSONBin...', 'info');
                    const response = await fetch(API_URL, {
                        headers: {
                            'X-Master-Key': MASTER_KEY,
                            'X-Access-Key': ACCESS_KEY
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    const jsonData = await response.json();

                    if (!jsonData.record || Object.keys(jsonData.record).length === 0) {
                        return {
                            meta: {
                                sistema: "Backlog do NOC",
                                versao: "1.0",
                                ultima_atualizacao: null,
                                criado_em: new Date().toISOString()
                            },
                            registros: []
                        };
                    }

                    const recordsWithTag = jsonData.record.registros.map(record => ({
                        ...record,
                        texto: record.texto + ' <span class="jsonbin-tag">[snz-b]</span>',
                        fonte: 'jsonbin'
                    }));

                    return {
                        ...jsonData.record,
                        registros: recordsWithTag
                    };
                } catch (error) {
                    console.error('Erro ao carregar dados do JSONBin:', error);
                    showToast('Erro ao carregar dados do JSONBin. Verifique o console.', 'error');
                    return {
                        meta: {
                            sistema: "Backlog do NOC",
                            versao: "1.0",
                            ultima_atualizacao: null,
                            criado_em: new Date().toISOString()
                        },
                        registros: []
                    };
                }
            }

            async function loadFirebaseData() {
                try {
                    const snapshot = await db.collection('backlog').get();
                    let allRegistros = [];

                    snapshot.forEach(doc => {
                        if (doc.id !== 'metadata') {
                            const registros = doc.data().registros || [];
                            allRegistros = [...allRegistros, ...registros];
                        }
                    });

                    return {
                        meta: {
                            sistema: "Backlog do NOC",
                            versao: "1.0",
                            ultima_atualizacao: new Date().toISOString(),
                            criado_em: new Date().toISOString()
                        },
                        registros: allRegistros
                    };
                } catch (error) {
                    console.error('Erro ao carregar dados do Firebase:', error);
                    return {
                        meta: {
                            sistema: "Backlog do NOC",
                            versao: "1.0",
                            ultima_atualizacao: null,
                            criado_em: new Date().toISOString()
                        },
                        registros: []
                    };
                }
            }

            async function saveBacklogRecord(analista, data, texto) {
                const docId = getBacklogDocId(data);
                const docRef = db.collection('backlog').doc(docId);
                const metadataRef = db.collection('backlog').doc('metadata');

                const now = new Date();
                const nowTimestampString = getFortalezaTimestamp();
                const nowFirestoreTs = firebase.firestore.Timestamp.now();

                const operationType = await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(docRef);
                    let registros = [];
                    if (doc.exists && doc.data().registros) {
                        registros = [...doc.data().registros];
                    }

                    const idx = registros.findIndex(r => r.analista === analista && r.data === data);

                    if (idx >= 0) {
                        const existing = registros[idx];

                        let createdAt;
                        if (existing.createdAt && typeof existing.createdAt.toDate === 'function') {
                            createdAt = existing.createdAt.toDate();
                        } else if (existing.createdAt) {
                            createdAt = new Date(existing.createdAt);
                        } else if (existing.timestamp) {
                            createdAt = new Date(existing.timestamp);
                        } else {
                            createdAt = now;
                        }

                        const saveCount = existing.saveCount ? Number(existing.saveCount) : 1;
                        const elapsedMs = now.getTime() - createdAt.getTime();

                        if (elapsedMs > BACKLOG_EDIT_WINDOW_MS) {
                            throw new Error('BACKLOG_EDIT_TIME_EXCEEDED');
                        }
                        if (saveCount >= MAX_BACKLOG_SAVES) {
                            throw new Error('BACKLOG_SAVE_LIMIT_REACHED');
                        }

                        registros[idx] = {
                            ...existing,
                            texto,
                            timestamp: nowTimestampString,
                            updatedAt: nowFirestoreTs,
                            createdAt: existing.createdAt || nowFirestoreTs,
                            saveCount: saveCount + 1
                        };

                        transaction.set(docRef, { registros }, { merge: true });
                        return 'updated';
                    } else {
                        const analistasDiaSet = new Set(
                            registros
                                .filter(r => r.data === data)
                                .map(r => r.analista)
                        );

                        if (!analistasDiaSet.has(analista) && analistasDiaSet.size >= 3) {
                            throw new Error('BACKLOG_MAX_ANALYSTS_REACHED');
                        }

                        const nextId = registros.reduce((max, r) => {
                            const idVal = typeof r.id === 'number' ? r.id : parseInt(r.id || 0, 10) || 0;
                            return Math.max(max, idVal);
                        }, 0) + 1;

                        const newRecord = {
                            id: nextId,
                            analista,
                            data,
                            texto,
                            timestamp: nowTimestampString,
                            createdAt: nowFirestoreTs,
                            updatedAt: nowFirestoreTs,
                            saveCount: 1
                        };

                        registros.push(newRecord);
                        transaction.set(docRef, { registros }, { merge: true });
                        return 'created';
                    }
                });

                await metadataRef.set({
                    sistema: "Backlog do NOC",
                    versao: "1.0",
                    ultima_atualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                    criado_em: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                return operationType;
            }

            navItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();

                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    const section = this.getAttribute('data-section');
                    sectionContents.forEach(content => content.style.display = 'none');
                    document.getElementById(`${section}-section`).style.display = 'block';

                    const sectionTitle = this.querySelector('span').textContent;
                    pageTitle.textContent = sectionTitle;

                    if (section === 'dashboard') {
                        initCalendar();
                        updateDashboardStats();
                    } else if (section === 'mural') {
                        initializeMural();
                    }
                });
            });

            clearFormBtn.addEventListener('click', function () {
                if (backlogText.innerHTML.trim() !== '' &&
                    !confirm('Tem certeza que deseja limpar o formul√°rio? Todo o conte√∫do n√£o salvo ser√° perdido.')) {
                    return;
                }
                dataBacklog.value = getFortalezaDateString();
                backlogText.innerHTML = '';
                showToast('Formul√°rio limpo com sucesso!');
            });

            backlogForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const analista = currentUser;
                const data = dataBacklog.value;
                let texto = backlogText.innerHTML.trim();

                if (!analista || !data || !texto) {
                    showToast('Por favor, preencha todos os campos obrigat√≥rios!', 'error');
                    return;
                }

                texto = cleanBacklogText(texto);

                try {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

                    const op = await saveBacklogRecord(analista, data, texto);

                    const firebaseData = await loadFirebaseData();
                    firebaseRecords = firebaseData.registros.map(r => ({
                        ...r,
                        fonte: 'firebase'
                    }));

                    const msg = op === 'updated'
                        ? 'Backlog atualizado com sucesso (dentro de 1 hora, limite de sobrescritas respeitado)!'
                        : 'Backlog salvo com sucesso!';

                    saveButton.innerHTML = '<i class="fas fa-check"></i> Salvo!';
                    saveButton.style.backgroundColor = '#34a853';
                    showToast(msg);

                    setTimeout(() => {
                        saveButton.innerHTML = '<i class="fas fa-save"></i> Salvar Backlog';
                        saveButton.style.backgroundColor = '';
                        saveButton.disabled = false;
                    }, 2000);

                    backlogText.innerHTML = '';

                    if (document.getElementById('dashboard-section').style.display !== 'none') {
                        initCalendar();
                        updateDashboardStats();
                    }
                } catch (error) {
                    console.error('Erro ao salvar:', error);

                    if (error.message === 'BACKLOG_EDIT_TIME_EXCEEDED') {
                        showValidationError('O backlog s√≥ pode ser alterado dentro de 1 hora ap√≥s o primeiro registro.');
                    } else if (error.message === 'BACKLOG_SAVE_LIMIT_REACHED') {
                        showValidationError('Limite de 4 sobrescritas atingido para este backlog (analista + dia).');
                    } else if (error.message === 'BACKLOG_MAX_ANALYSTS_REACHED') {
                        showValidationError('Limite m√°ximo de 3 analistas diferentes por dia atingido. N√£o √© poss√≠vel salvar mais backlogs nesta data.');
                    } else {
                        showToast('Erro ao salvar os dados. Verifique o console para detalhes.', 'error');
                    }

                    saveButton.innerHTML = '<i class="fas fa-save"></i> Salvar Backlog';
                    saveButton.disabled = false;
                }
            });

            function getAnalystColor(analista) {
                const colors = {
                    'DELANO': '#65a30d',
                    'HERBETH': '#dc2626',
                    'WELLIGTON': '#ea580c',
                    'EDMUNDO': '#8b5cf6',
                    'SIDNEY': '#14b8a6',
                    'MARCIO': '#ec4899',
                    'HELIELTON': '#3b82f6',
                    'ROBSON': '#f59e0b',
                    'WYLLAME': '#059669',
                    'DARLYSON': '#d946ef',
                    'MURILO': '#06b6d4',
                    'ONOFRE': '#f97316',
                    'LYNNA': '#be185d'
                };
                return colors[analista] || '#3b82f6';
            }

            function updateDashboardStats() {
                const allRecords = [
                    ...backlogData.registros,
                    ...firebaseRecords
                ];

                const today = getFortalezaDateString();
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();

                const selectedMonth = monthSelect.value;
                let filteredRecords = allRecords;

                if (selectedMonth) {
                    const [year, month] = selectedMonth.split('-');
                    filteredRecords = allRecords.filter(record => {
                        const recordDate = new Date(record.data);
                        return recordDate.getFullYear() == year &&
                            (recordDate.getMonth() + 1) == month;
                    });
                }

                const todayValidations = filteredRecords.filter(r => r.data === today).length;
                const yesterday = new Date(new Date(today).getTime() - 86400000).toISOString().split('T')[0];
                const yesterdayValidations = filteredRecords.filter(r => r.data === yesterday).length;

                validationsTodayEl.textContent = todayValidations;

                let todayChange = 0;
                if (yesterdayValidations > 0) {
                    todayChange = Math.round(((todayValidations - yesterdayValidations) / yesterdayValidations) * 100);
                } else if (todayValidations > 0) {
                    todayChange = 100;
                }

                if (todayChange > 0) {
                    todayChangeEl.innerHTML = `<i class="fas fa-caret-up"></i> ${todayChange}% em rela√ß√£o a ontem`;
                    todayChangeEl.className = 'stat-change positive';
                } else if (todayChange < 0) {
                    todayChangeEl.innerHTML = `<i class="fas fa-caret-down"></i> ${Math.abs(todayChange)}% em rela√ß√£o a ontem`;
                    todayChangeEl.className = 'stat-change negative';
                } else {
                    todayChangeEl.innerHTML = `<i class="fas fa-equals"></i> 0% em rela√ß√£o a ontem`;
                    todayChangeEl.className = 'stat-change';
                }

                const currentMonthValidations = filteredRecords.filter(record => {
                    const d = new Date(record.data);
                    return d.getMonth() + 1 === currentMonth &&
                        d.getFullYear() === currentYear;
                }).length;

                const lastMonth = currentMonth === 1 ? 12 : currentMonth - 1;
                const lastMonthYear = currentMonth === 1 ? currentYear - 1 : currentYear;
                const lastMonthValidations = filteredRecords.filter(record => {
                    const d = new Date(record.data);
                    return d.getMonth() + 1 === lastMonth &&
                        d.getFullYear() === lastMonthYear;
                }).length;

                validationsMonthEl.textContent = currentMonthValidations;

                let monthChange = 0;
                if (lastMonthValidations > 0) {
                    monthChange = Math.round(((currentMonthValidations - lastMonthValidations) / lastMonthValidations) * 100);
                } else if (currentMonthValidations > 0) {
                    monthChange = 100;
                }

                if (monthChange > 0) {
                    monthChangeEl.innerHTML = `<i class="fas fa-caret-up"></i> ${monthChange}% em rela√ß√£o ao m√™s passado`;
                    monthChangeEl.className = 'stat-change positive';
                } else if (monthChange < 0) {
                    monthChangeEl.innerHTML = `<i class="fas fa-caret-down"></i> ${Math.abs(monthChange)}% em rela√ß√£o ao m√™s passado`;
                    monthChangeEl.className = 'stat-change negative';
                } else {
                    monthChangeEl.innerHTML = `<i class="fas fa-equals"></i> 0% em rela√ß√£o ao m√™s passado`;
                    monthChangeEl.className = 'stat-change';
                }

                const analystCounts = {};
                filteredRecords.forEach(record => {
                    if (!analystCounts[record.analista]) {
                        analystCounts[record.analista] = 0;
                    }
                    analystCounts[record.analista]++;
                });

                const sortedAnalysts = Object.entries(analystCounts).sort((a, b) => b[1] - a[1]);

                if (sortedAnalysts.length > 0) {
                    topAnalystEl.textContent = sortedAnalysts[0][0];
                    topAnalystCountEl.textContent = `${sortedAnalysts[0][1]} valida√ß√µes`;
                } else {
                    topAnalystEl.textContent = 'N/A';
                    topAnalystCountEl.textContent = '0 valida√ß√µes';
                }

                topAnalystsEl.innerHTML = '';
                sortedAnalysts.slice(0, 3).forEach((analyst, index) => {
                    const medalClass = index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze';

                    const analystElDiv = document.createElement('div');
                    analystElDiv.className = 'analyst-item';
                    analystElDiv.innerHTML = `
                        <div>
                            <span class="medal ${medalClass}"><i class="fas fa-medal"></i></span>
                            <span class="analyst-name">${analyst[0]}</span>
                        </div>
                        <span class="analyst-count">${analyst[1]} valida√ß√µes</span>
                    `;
                    topAnalystsEl.appendChild(analystElDiv);
                });

                bottomAnalystsEl.innerHTML = '';
                if (sortedAnalysts.length > 3) {
                    sortedAnalysts.slice(-3).reverse().forEach(analyst => {
                        const el = document.createElement('div');
                        el.className = 'analyst-item';
                        el.innerHTML = `
                            <span class="analyst-name">${analyst[0]}</span>
                            <span class="analyst-count">${analyst[1]} valida√ß√£o${analyst[1] !== 1 ? 's' : ''}</span>
                        `;
                        bottomAnalystsEl.appendChild(el);
                    });
                } else if (sortedAnalysts.length > 0) {
                    bottomAnalystsEl.innerHTML = '<p>Todos os analistas est√£o no ranking!</p>';
                } else {
                    bottomAnalystsEl.innerHTML = '<p>Nenhum dado dispon√≠vel</p>';
                }

                updateAnalystChart(sortedAnalysts);
            }

            function updateAnalystChart(sortedAnalysts) {
                const labels = sortedAnalysts.map(item => item[0]);
                const data = sortedAnalysts.map(item => item[1]);
                const backgroundColors = sortedAnalysts.map(item => getAnalystColor(item[0]));

                if (analystChart) {
                    analystChart.data.labels = labels;
                    analystChart.data.datasets[0].data = data;
                    analystChart.data.datasets[0].backgroundColor = backgroundColors;
                    analystChart.update();
                } else {
                    const ctx = analystChartEl.getContext('2d');
                    analystChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Valida√ß√µes por Analista',
                                data,
                                backgroundColor: backgroundColors,
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 32, 44, 0.9)',
                                    titleColor: '#e2e8f0',
                                    bodyColor: '#a0aec0',
                                    borderColor: 'rgba(255, 255, 255, 0.1)',
                                    borderWidth: 1,
                                    padding: 12,
                                    usePointStyle: true
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                    ticks: { color: '#a0aec0' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#a0aec0' }
                                }
                            }
                        }
                    });
                }
            }

            function populateMonthSelect() {
                monthSelect.innerHTML = '<option value="">Todos os meses</option>';

                const allRecords = [
                    ...backlogData.registros,
                    ...firebaseRecords
                ];

                if (allRecords.length === 0) return;

                const months = new Set();
                allRecords.forEach(record => {
                    const d = new Date(record.data);
                    const y = d.getFullYear();
                    const m = d.getMonth() + 1;
                    months.add(`${y}-${m.toString().padStart(2, '0')}`);
                });

                const sortedMonths = Array.from(months).sort((a, b) => new Date(b) - new Date(a));

                sortedMonths.forEach(month => {
                    const [year, monthNum] = month.split('-');
                    const monthName = new Date(`${year}-${monthNum}-01`).toLocaleDateString('pt-BR', {
                        month: 'long',
                        year: 'numeric'
                    });

                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                    monthSelect.appendChild(option);
                });

                monthSelect.addEventListener('change', updateDashboardStats);
            }

            async function initCalendar() {
                try {
                    const calendarEl = document.getElementById('calendar');
                    calendarEl.innerHTML = '';

                    const allRecords = [
                        ...backlogData.registros,
                        ...firebaseRecords
                    ];

                    const events = allRecords.map(entry => ({
                        title: entry.analista,
                        start: entry.data,
                        extendedProps: {
                            texto: entry.texto,
                            analista: entry.analista,
                            fonte: entry.fonte
                        },
                        className: `event-${entry.analista.toLowerCase()} fc-event-analyst has-tooltip`
                    }));

                    const calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        locale: 'pt-br',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,dayGridWeek,dayGridDay'
                        },
                        events,
                        eventContent: function (arg) {
                            const eventEl = document.createElement('div');
                            eventEl.className = 'fc-event-content';
                            eventEl.style.display = 'flex';
                            eventEl.style.alignItems = 'center';
                            eventEl.style.padding = '0.25rem 0.5rem';
                            eventEl.style.gap = '0.5rem';

                            const iconEl = document.createElement('i');
                            iconEl.className = 'fas fa-user-check';
                            iconEl.style.fontSize = '0.8em';

                            const titleEl = document.createElement('span');
                            titleEl.className = 'fc-event-title';
                            titleEl.textContent = arg.event.title;

                            const tooltipEl = document.createElement('div');
                            tooltipEl.className = 'tooltip';
                            tooltipEl.textContent = arg.event.extendedProps.fonte === 'jsonbin'
                                ? 'Origem: JSONBin' : 'Origem: Firebase';

                            eventEl.appendChild(iconEl);
                            eventEl.appendChild(titleEl);
                            eventEl.appendChild(tooltipEl);

                            return { domNodes: [eventEl] };
                        },
                        eventClick: function (info) {
                            const modal = document.createElement('div');
                            modal.className = 'fc-event-modal';

                            const modalContent = document.createElement('div');
                            modalContent.className = 'fc-event-modal-content';

                            const modalHeader = document.createElement('div');
                            modalHeader.className = 'fc-event-modal-header';

                            const modalTitle = document.createElement('h3');
                            modalTitle.className = 'fc-event-modal-title';
                            modalTitle.textContent = 'Detalhes da Valida√ß√£o';

                            const closeButton = document.createElement('button');
                            closeButton.className = 'fc-event-modal-close';
                            closeButton.innerHTML = '<i class="fas fa-times"></i>';
                            closeButton.addEventListener('click', () => {
                                document.body.removeChild(modal);
                            });

                            modalHeader.appendChild(modalTitle);
                            modalHeader.appendChild(closeButton);

                            const modalBody = document.createElement('div');

                            const dateEl = document.createElement('div');
                            dateEl.style.marginBottom = '1.5rem';
                            dateEl.style.fontSize = '0.95rem';
                            dateEl.style.color = 'var(--gray)';
                            dateEl.innerHTML = `<i class="far fa-calendar-alt" style="margin-right: 0.5rem;"></i> ${new Date(info.event.start).toLocaleDateString('pt-BR')}`;

                            const sourceEl = document.createElement('div');
                            sourceEl.style.marginBottom = '1rem';
                            sourceEl.style.fontSize = '0.85rem';
                            sourceEl.style.color = 'var(--gray)';
                            sourceEl.innerHTML = `<i class="fas fa-database" style="margin-right: 0.5rem;"></i> ${info.event.extendedProps.fonte === 'jsonbin' ? 'JSONBin' : 'Firebase'}`;

                            const analystItem = document.createElement('div');
                            analystItem.className = 'fc-event-analyst-item';

                            const analystName = document.createElement('div');
                            analystName.className = 'fc-event-analyst-name';
                            analystName.innerHTML = `<i class="fas fa-user-tie" style="color: ${getAnalystColor(info.event.extendedProps.analista)}"></i> ${info.event.extendedProps.analista}`;

                            const analystContent = document.createElement('div');
                            analystContent.className = 'fc-event-analyst-content';
                            analystContent.innerHTML = (info.event.extendedProps.texto || '')
                                .replace('<span class="jsonbin-tag">[snz-b]</span>', '');

                            analystItem.appendChild(analystName);
                            analystItem.appendChild(analystContent);

                            modalBody.appendChild(dateEl);
                            modalBody.appendChild(sourceEl);
                            modalBody.appendChild(analystItem);

                            modalContent.appendChild(modalHeader);
                            modalContent.appendChild(modalBody);
                            modal.appendChild(modalContent);
                            document.body.appendChild(modal);
                        },
                        viewDidMount: function () {
                            const header = document.querySelector('.fc-header-toolbar');
                            if (header) {
                                header.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                                header.style.backdropFilter = 'blur(10px)';
                                header.style.borderRadius = '1rem 1rem 0 0';
                                header.style.padding = '1.5rem';
                                header.style.borderBottom = '1px solid var(--glass-border)';
                            }

                            const buttons = document.querySelectorAll('.fc-button');
                            buttons.forEach(button => {
                                button.style.backdropFilter = 'blur(5px)';
                                button.style.border = '1px solid var(--glass-border)';
                            });
                        }
                    });

                    calendar.render();
                } catch (error) {
                    console.error('Erro ao inicializar calend√°rio:', error);
                    showToast('Erro ao carregar o calend√°rio', 'error');
                }
            }

            // ========== FUN√á√ïES DO MURAL CYAN/TEAL ==========
            
            function formatTime(date) {
                if (!date) return '';
                return date.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'America/Fortaleza'
                });
            }

            function escHTML(str) {
                return String(str)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }

            function formatTextWithINCs(text) {
                const safe = escHTML(text).replace(/\n/g, '<br>');
                const incRegex = /(^|\s)(INC\d{5,})(?=\s|$)/gi;
                return safe.replace(incRegex, (m, p1, incRaw) => {
                    const sp = p1 || '';
                    const inc = incRaw.toUpperCase();
                    const url = `https://equatorialenergia.service-now.com/incident.do?sysparm_query=number=${inc}`;
                    return `${sp}<span class="inc-pill" data-inc="${inc}" data-url="${url}"><i class="fa-solid fa-link"></i>${inc}</span>`;
                });
            }

            async function copyPlain(html) {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                await navigator.clipboard.writeText(tmp.innerText);
            }

            function flash(element) {
                if (!element) return;
                element.classList.remove('flash');
                void element.offsetWidth;
                element.classList.add('flash');
                setTimeout(() => element.classList.remove('flash'), 380);
            }

            // Auto-resize da textarea
            if (chatInput) {
                chatInput.addEventListener('input', function() {
                    this.style.height = '0px';
                    const h = Math.min(this.scrollHeight, 140);
                    this.style.height = h + 'px';
                });
            }

            // FUN√á√ÉO CORRIGIDA PARA LIMPAR MENSAGENS ANTIGAS
            async function checkAndClearOldMessages() {
                const today = getFortalezaDateString();
                
                try {
                    const metadataDoc = await muralMetadataRef.get();
                    let lastClearDate = metadataDoc.exists ? metadataDoc.data().lastClearDate : null;

                    if (!lastClearDate || lastClearDate !== today) {
                        console.log('Verificando mensagens antigas do mural...');
                        
                        const snapshot = await muralMessagesRef.get();
                        
                        if (!snapshot.empty) {
                            const batch = db.batch();
                            let deletedCount = 0;
                            
                            snapshot.forEach(doc => {
                                const msgData = doc.data();
                                const msgDate = msgData.date;
                                
                                if (msgDate !== today) {
                                    batch.delete(doc.ref);
                                    deletedCount++;
                                }
                            });
                            
                            if (deletedCount > 0) {
                                await batch.commit();
                                console.log(`Mural limpo: ${deletedCount} mensagens antigas removidas.`);
                                showToast(`Mural limpo: ${deletedCount} mensagens de dias anteriores foram removidas`, 'info', 3000);
                            }
                        }
                        
                        await muralMetadataRef.set({ 
                            lastClearDate: today, 
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp() 
                        }, { merge: true });
                    }
                } catch (error) {
                    console.error('Erro ao limpar mensagens antigas:', error);
                }
            }

            // Fun√ß√£o para agendar limpeza √† meia-noite
            function scheduleMidnightCleanup() {
                const now = new Date();
                const night = new Date(
                    now.getFullYear(),
                    now.getMonth(),
                    now.getDate() + 1,
                    0, 0, 0
                );
                const msToMidnight = night.getTime() - now.getTime();
                
                setTimeout(() => {
                    checkAndClearOldMessages();
                    scheduleMidnightCleanup();
                }, msToMidnight);
                
                console.log(`Pr√≥xima limpeza autom√°tica em ${Math.round(msToMidnight / 1000 / 60)} minutos`);
            }

            // Fun√ß√£o para habilitar edi√ß√£o
            function enableEdit(messageDiv, msgId, oldText) {
                const bubble = messageDiv.querySelector('.message-bubble');
                const originalContent = bubble.innerHTML;

                bubble.innerHTML = `
                    <div class="edit-mode">
                        <textarea id="edit-textarea-${msgId}">${oldText.replace(/<br>/g, '\n')}</textarea>
                        <div class="edit-actions">
                            <button class="save-edit" data-id="${msgId}"><i class="fa-solid fa-check"></i>Salvar</button>
                            <button class="cancel-edit cancel" data-id="${msgId}"><i class="fa-solid fa-xmark"></i>Cancelar</button>
                        </div>
                    </div>
                `;

                const textarea = bubble.querySelector('textarea');
                textarea.focus();

                const autoResize = () => {
                    textarea.style.height = '0px';
                    textarea.style.height = Math.min(textarea.scrollHeight, 240) + 'px';
                };
                
                textarea.addEventListener('input', autoResize);
                autoResize();

                bubble.querySelector('.save-edit').addEventListener('click', async () => {
                    const newText = textarea.value.trim();
                    if (!newText) return;

                    try {
                        await muralMessagesRef.doc(msgId).update({
                            text: newText,
                            edited: true,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showToast('Mensagem editada', 'success');
                    } catch (error) {
                        console.error('Erro ao editar:', error);
                        showToast('Erro ao editar', 'error');
                    }
                });

                bubble.querySelector('.cancel-edit').addEventListener('click', () => {
                    bubble.innerHTML = originalContent;
                });
            }

            // Fun√ß√£o para apagar mensagem
            async function deleteMessage(messageDiv, msgId) {
                if (!confirm('Tem certeza que deseja apagar esta mensagem?')) return;
                
                messageDiv.classList.add('deleting');
                
                setTimeout(async () => {
                    try {
                        await muralMessagesRef.doc(msgId).delete();
                        showToast('Mensagem apagada!', 'success');
                    } catch (error) {
                        console.error('Erro ao apagar:', error);
                        showToast('Erro ao apagar mensagem', 'error');
                    }
                }, 220);
            }

            // FUN√á√ÉO CORRIGIDA PARA CARREGAR MENSAGENS (s√≥ do dia atual)
// FUN√á√ÉO FINAL - sem mensagem autom√°tica
function loadMuralMessages() {
    const today = getFortalezaDateString();
    
    const q = db.collection('mural_messages').where('date', '==', today);
    
    const unsubscribe = q.onSnapshot(snapshot => {
        let html = '';
        
        if (!snapshot.empty) {
            const messages = [];
            snapshot.forEach(doc => {
                messages.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            messages.sort((a, b) => {
                const timeA = a.timestamp?.toDate?.() || new Date(0);
                const timeB = b.timestamp?.toDate?.() || new Date(0);
                return timeA - timeB;
            });
            
            messages.forEach(msg => {
                const isOwn = msg.analyst === currentUser;
                const timeStr = msg.timestamp?.toDate ? formatTime(msg.timestamp.toDate()) : '';
                const editedHtml = msg.edited ? '<span class="edited-badge">(editado)</span>' : '';
                const isSystem = msg.system ? 'system' : '';

                const contentHTML = formatTextWithINCs(msg.text);

                html += `
                    <div class="message-wrapper ${isOwn ? 'own' : ''} ${isSystem}" data-id="${msg.id}">
                        <div class="message-bubble">
                            <div class="message-header">
                                <span class="message-author">${escHTML(msg.analyst)}</span>
                                <span class="message-time">${timeStr} ${editedHtml}</span>
                            </div>
                            <div class="message-content">${contentHTML}</div>
                            <div class="message-footer">
                                <button class="copy-msg" data-id="${msg.id}"><i class="fa-regular fa-copy"></i>Copiar</button>
                                ${isOwn && !msg.system ? `
                                    <button class="edit-msg" data-id="${msg.id}"><i class="fa-solid fa-pen"></i>Editar</button>
                                    <button class="delete-msg danger" data-id="${msg.id}"><i class="fa-solid fa-trash"></i>Excluir</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        if (html === '') {
            html = '<div style="text-align:center; color:rgba(232,251,255,.45); padding:20px;">üëã Nenhuma mensagem ainda. Comece a conversa!</div>';
        }
        
        chatMessages.innerHTML = html;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
    }, error => {
        console.error('Erro no listener do mural:', error);
        showToast('Erro ao carregar mensagens do mural', 'error');
    });

    return unsubscribe;
}

            // Fun√ß√£o para enviar mensagem
            async function sendMessage() {
                const text = chatInput.value.trim();
                if (!text) return;

                const today = getFortalezaDateString();
                
                chatSend.disabled = true;
                
                try {
                    await muralMessagesRef.add({
                        analyst: currentUser,
                        text: text,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        date: today,
                        edited: false
                    });
                    
                    chatInput.value = '';
                    chatInput.style.height = '24px';
                    showToast('Mensagem enviada!', 'success');
                    
                } catch (error) {
                    console.error('Erro ao enviar:', error);
                    showToast('Erro ao enviar mensagem', 'error');
                } finally {
                    chatSend.disabled = false;
                }
            }

            // Event delegation para bot√µes do mural
            if (chatMessages) {
                chatMessages.addEventListener('click', async (e) => {
                    const inc = e.target.closest('.inc-pill');
                    if (inc) {
                        try {
                            await navigator.clipboard.writeText(inc.dataset.inc);
                            showToast(`${inc.dataset.inc} copiado!`, "success", 1500);
                            flash(inc.closest('.message-bubble'));
                        } catch {
                            showToast("Falha ao copiar INC", "error");
                        }
                        return;
                    }

                    const target = e.target.closest('button');
                    if (!target) return;

                    const messageDiv = target.closest('.message-wrapper');
                    if (!messageDiv) return;

                    const msgId = messageDiv.dataset.id;
                    const contentDiv = messageDiv.querySelector('.message-content');

                    if (target.classList.contains('copy-msg')) {
                        try {
                            await copyPlain(contentDiv.innerHTML);
                            showToast('Mensagem copiada!', 'success');
                            flash(messageDiv.querySelector('.message-bubble'));
                        } catch {
                            showToast('Erro ao copiar', 'error');
                        }
                    }

                    if (target.classList.contains('edit-msg')) {
                        const oldText = contentDiv.innerHTML.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
                        enableEdit(messageDiv, msgId, oldText);
                    }
                    
                    if (target.classList.contains('delete-msg')) {
                        deleteMessage(messageDiv, msgId);
                    }
                });

                // Duplo clique no INC abre ServiceNow
                chatMessages.addEventListener('dblclick', (e) => {
                    const inc = e.target.closest('.inc-pill');
                    if (inc) {
                        window.open(inc.dataset.url, '_blank');
                    }
                });
            }

            // Eventos do mural
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            if (chatSend) {
                chatSend.addEventListener('click', sendMessage);
            }

            // Executar limpeza de dias anteriores e iniciar listener
            async function initializeMural() {
                await checkAndClearOldMessages();
                if (muralUnsubscribe) {
                    muralUnsubscribe();
                }
                muralUnsubscribe = loadMuralMessages();
            }

            // Inicia o agendamento da limpeza √† meia-noite
            scheduleMidnightCleanup();

            // Verificar limpeza sempre que a janela for focada
            window.addEventListener('focus', async () => {
                await checkAndClearOldMessages();
            });

            async function loadInitialData() {
                try {
                    const [jsonbinData, firebaseData] = await Promise.all([
                        loadJsonBinData(),
                        loadFirebaseData()
                    ]);

                    backlogData = jsonbinData;
                    firebaseRecords = firebaseData.registros.map(r => ({
                        ...r,
                        fonte: 'firebase'
                    }));

                    showToast('Dados carregados com sucesso!');
                    populateMonthSelect();
                    updateDashboardStats();

                } catch (error) {
                    console.error('Erro ao carregar dados iniciais:', error);
                    showToast('Erro ao carregar dados. Verifique o console.', 'error');
                }
            }

            loadInitialData();
        }
    </script>
</body>
</html>
